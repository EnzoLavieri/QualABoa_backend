


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MapService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.eti.qualaboa.map.service</a>
</div>

<h1>Coverage Summary for Class: MapService (com.eti.qualaboa.map.service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MapService</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    59,5%
  </span>
  <span class="absValue">
    (25/42)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    95,9%
  </span>
  <span class="absValue">
    (70/73)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.eti.qualaboa.map.service;
&nbsp;
&nbsp;import com.eti.qualaboa.estabelecimento.model.Estabelecimento;
&nbsp;import com.eti.qualaboa.estabelecimento.repository.EstabelecimentoRepository;
&nbsp;import com.eti.qualaboa.map.dto.PinDTO;
&nbsp;import com.eti.qualaboa.map.places.PlacesClient;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.cache.Cache;
&nbsp;import org.springframework.cache.CacheManager;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;public class MapService {
&nbsp;
&nbsp;    private final EstabelecimentoRepository estRepo;
&nbsp;    private final PlacesClient placesClient;
&nbsp;    private final CacheManager cacheManager;
&nbsp;
&nbsp;    public List&lt;PinDTO&gt; getPinsNearby(double lat, double lng, int radiusMeters, String keyword) {
<b class="fc">&nbsp;        log.info(&quot;Buscando locais prÃ³ximos de ({}, {}) com raio {}m e keyword=&#39;{}&#39;&quot;, lat, lng, radiusMeters, keyword);</b>
&nbsp;
&nbsp;        // ðŸ”¹ 1. Buscar parceiros no banco
<b class="fc">&nbsp;        List&lt;Estabelecimento&gt; partners = estRepo.findAllWithinRadiusPostGis(lat, lng, radiusMeters)</b>
<b class="fc">&nbsp;                .stream()</b>
<b class="fc">&nbsp;                .filter(e -&gt; Boolean.TRUE.equals(e.getParceiro()))</b>
<b class="fc">&nbsp;                .collect(Collectors.toList());</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, PinDTO&gt; map = new LinkedHashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        for (Estabelecimento e : partners) {</b>
<b class="fc">&nbsp;            PinDTO p = PinDTO.builder()</b>
<b class="fc">&nbsp;                    .id(e.getIdEstabelecimento())</b>
<b class="fc">&nbsp;                    .placeId(e.getPlaceId())</b>
<b class="fc">&nbsp;                    .nome(e.getNome())</b>
<b class="fc">&nbsp;                    .lat(e.getLatitude())</b>
<b class="fc">&nbsp;                    .lng(e.getLongitude())</b>
<b class="fc">&nbsp;                    .isPartner(true)</b>
<b class="fc">&nbsp;                    .snippet(e.getDescricao())</b>
<b class="fc">&nbsp;                    .endereco(e.getEnderecoFormatado())</b>
<b class="fc">&nbsp;                    .build();</b>
<b class="pc">&nbsp;            map.put(e.getPlaceId() != null ? e.getPlaceId() : &quot;local-&quot; + e.getIdEstabelecimento(), p);</b>
&nbsp;        }
&nbsp;
&nbsp;        // ðŸ”¹ 2. Buscar locais no Google Places API
<b class="pc">&nbsp;        String cacheKey = &quot;places:&quot; + lat + &quot;:&quot; + lng + &quot;:&quot; + radiusMeters + &quot;:&quot; + (keyword == null ? &quot;&quot; : keyword);</b>
<b class="fc">&nbsp;        Map&lt;String, Object&gt; placesResp = getPlacesCached(cacheKey, lat, lng, radiusMeters, keyword);</b>
&nbsp;
<b class="pc">&nbsp;        if (placesResp != null &amp;&amp; placesResp.containsKey(&quot;results&quot;)) {</b>
<b class="fc">&nbsp;            Object rawResults = placesResp.get(&quot;results&quot;);</b>
<b class="pc">&nbsp;            if (rawResults instanceof List&lt;?&gt;) {</b>
<b class="fc">&nbsp;                List&lt;?&gt; results = (List&lt;?&gt;) rawResults;</b>
<b class="fc">&nbsp;                log.info(&quot;Foram encontrados {} resultados do Google Places.&quot;, results.size());</b>
&nbsp;
<b class="fc">&nbsp;                for (Object obj : results) {</b>
<b class="pc">&nbsp;                    if (!(obj instanceof Map&lt;?, ?&gt; r)) continue;</b>
&nbsp;
<b class="fc">&nbsp;                    String placeId = (String) r.get(&quot;place_id&quot;);</b>
<b class="fc">&nbsp;                    if (map.containsKey(placeId)) continue; // evita duplicar parceiros</b>
&nbsp;
<b class="fc">&nbsp;                    Map&lt;String, Object&gt; geometry = (Map&lt;String, Object&gt;) r.get(&quot;geometry&quot;);</b>
<b class="pc">&nbsp;                    if (geometry == null) continue;</b>
&nbsp;
<b class="fc">&nbsp;                    Map&lt;String, Object&gt; location = (Map&lt;String, Object&gt;) geometry.get(&quot;location&quot;);</b>
<b class="pc">&nbsp;                    if (location == null) continue;</b>
&nbsp;
<b class="fc">&nbsp;                    Double plat = ((Number) location.get(&quot;lat&quot;)).doubleValue();</b>
<b class="fc">&nbsp;                    Double plng = ((Number) location.get(&quot;lng&quot;)).doubleValue();</b>
&nbsp;
<b class="fc">&nbsp;                    String name = (String) r.get(&quot;name&quot;);</b>
<b class="fc">&nbsp;                    String vicinity = (String) r.get(&quot;vicinity&quot;);</b>
&nbsp;
<b class="fc">&nbsp;                    map.put(placeId, PinDTO.builder()</b>
<b class="fc">&nbsp;                            .id(null)</b>
<b class="fc">&nbsp;                            .placeId(placeId)</b>
<b class="fc">&nbsp;                            .nome(name)</b>
<b class="fc">&nbsp;                            .lat(plat)</b>
<b class="fc">&nbsp;                            .lng(plng)</b>
<b class="fc">&nbsp;                            .isPartner(false)</b>
<b class="fc">&nbsp;                            .snippet(vicinity)</b>
<b class="fc">&nbsp;                            .endereco(vicinity)</b>
<b class="fc">&nbsp;                            .build());</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                log.warn(&quot;Campo &#39;results&#39; inesperado na resposta do Google: {}&quot;, rawResults);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            log.warn(&quot;Nenhum resultado retornado do Google Places (status={})&quot;,</b>
<b class="nc">&nbsp;                    placesResp != null ? placesResp.get(&quot;status&quot;) : &quot;null&quot;);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return new ArrayList&lt;&gt;(map.values());</b>
&nbsp;    }
&nbsp;
&nbsp;    private Map&lt;String, Object&gt; getPlacesCached(String cacheKey, double lat, double lng, int radius, String keyword) {
<b class="fc">&nbsp;        Cache cache = cacheManager.getCache(&quot;places&quot;);</b>
<b class="pc">&nbsp;        if (cache != null) {</b>
<b class="fc">&nbsp;            Map&lt;String, Object&gt; cached = cache.get(cacheKey, Map.class);</b>
<b class="fc">&nbsp;            if (cached != null) {</b>
<b class="fc">&nbsp;                log.info(&quot;Cache HIT para {}&quot;, cacheKey);</b>
<b class="fc">&nbsp;                return cached;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, Object&gt; resp = placesClient.nearbySearch(lat, lng, radius,</b>
<b class="pc">&nbsp;                keyword == null ? &quot;bar|restaurant&quot; : keyword);</b>
<b class="pc">&nbsp;        if (cache != null &amp;&amp; resp != null) {</b>
<b class="fc">&nbsp;            cache.put(cacheKey, resp);</b>
&nbsp;        }
<b class="fc">&nbsp;        return resp;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Map&lt;String, Object&gt; getPlaceDetailsCached(String placeId) {
<b class="fc">&nbsp;        Cache cache = cacheManager.getCache(&quot;placeDetails&quot;);</b>
<b class="pc">&nbsp;        if (cache != null) {</b>
<b class="fc">&nbsp;            Map&lt;String, Object&gt; cached = cache.get(placeId, Map.class);</b>
<b class="fc">&nbsp;            if (cached != null) {</b>
<b class="fc">&nbsp;                log.info(&quot;Cache HIT para detalhes {}&quot;, placeId);</b>
<b class="fc">&nbsp;                return cached;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, Object&gt; details = placesClient.placeDetails(placeId);</b>
<b class="pc">&nbsp;        if (cache != null &amp;&amp; details != null) {</b>
<b class="fc">&nbsp;            cache.put(placeId, details);</b>
&nbsp;        }
<b class="fc">&nbsp;        return details;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-16 15:03</div>
</div>
</body>
</html>
